clear all
close all
clc

% cam = webcam;
% while(1)
%     img = snapshot(cam);
%     img = imresize(img,0.125);
%     Pyr_Search(img);
% %     img = imresize(img,8);
% %     imshow(img);
% end
win_size = [30,30]; %[row,col]
win_size = [64,32];
% win_size = [32,24]; %[row,col]
% test_dir = 'E:\RnD\Current_Projects\Musawwir\Frameworks\SW\Dataset\Face\1\test3\';
test_dir = 'E:\RnD\Current_Projects\Musawwir\Frameworks\SW\Dataset\TrafficSigns\test\';

test_files = dir(test_dir);
test_files = {test_files.name}';
test_files_cnt = length(test_files);

img = imread('E:\RnD\Current_Projects\Musawwir\Frameworks\SW\Dataset\Person\test_images\2.jpg');
img = imresize(img,0.0625);
imshow(img)
figure
img_out = Pyr_Search(img,win_size);
    imshow(img_out);
pause

k = 1;
for i=3:test_files_cnt,
    img = imread([test_dir,test_files{i}]);
%     img = imresize(img,0.5);
    img_out = Pyr_Search(img,win_size);
    imshow(img_out);
    imwrite(img_out,[test_dir,'out_',test_files{i}],'jpg')
    drawnow
%     pause;
end

function img_save = Pyr_Search(img_in,win_size)
% wts = [-0.0181705985035007,0.0218406138894211,0.0815359820543056,0.0131245560861582,-0.0238120379677096,-0.00794147695752249,-0.0216795940712685,-0.0455430567666823,0.0899068012851589,0.0178055554395793,0.0417979328087855,-0.0408159024148006,-0.0152483906242625,-0.0432264485979027,-0.0530633032535557,0.00181088414673960,0.0514457009035823,0.0693115507499021,-0.0651756785431388,-0.0182276347090612,-0.0418658999139329,-0.00842571241798738,-0.0547196191687990,0.00985768456570541,-0.0371695659966369,0.0522512709377281,-0.0304711806626842,0.0234370675450698,-0.0314808642376337,0.00104212024832831,-0.0427433294426573,0.0168586291844335,-0.00849343484783386,-0.0593661693905277,-0.0144040549313332,-0.0372376777763667,0.0298726934416624,-0.0173583034954607,0.0308926221754249,-0.0200782618219314,0.0403137204166269,-0.00873190046296318,-0.00134273227581550,-0.0358424668820894,-0.00871055121270302,-0.0314041761621375,0.0206151590493386,-0.00331747443797102,0.0173388370513176,-0.0337016226551529,-0.0337325264911264,-0.0460574140496358,0.0187328803702727,-0.00124339892103082,0.0586730316312279,0.0925807413016721,-0.0303347175770759,-0.0473962959514446,-0.0228315592259352,0.0437438021077076,-0.0388495685341920,0.0765129981683275,0.0468505444507967,-0.0232077345754102,-0.0284953050904729,0.0264293466143408,0.0429877891975806,-0.0139836235844290,-0.00533941190361342,-0.0250839847290545,-0.00949725411921817,-0.0634923445813676,-0.0647447464477192,0.000268740898796796,0.0667857957115671,0.00123203008199192,0.00126384364612864,-0.0890819637219243,-0.0681567903649297,0.00420168641332106,-0.0812458913824224,-0.00334540251238158,-0.0220747353182953,-0.0206013189489352,-0.0704759644261146,0.00581800033288089,-0.0363456191829171,0.0445078642314480,0.00952674303538033,0.0333977125716044,-0.0231349085075946,0.0113738373930708,-0.0598038444674074,0.0392188729205384,-0.00863523615735301,0.0228136247015964,0.0163253956730756,0.0218351678575383,-0.0102346085806633,-0.00291042414520887,-0.0211625240425298,-0.00952732114091310,0.0694840111609787,0.0185927103953468,0.0409150251745392,0.0308138941107726,0.0151684558681422,-0.0280041677476678,-0.0217064299345954,-0.0252949349990806,0.00906362889475728,-0.0245162637452709,0.0428002764549488,-0.0474702390483153,-0.0255181398630688,-0.0545431889436661,0.0197742089500074,0.0123265542134483,0.0197454137200422,-0.0358431929939102,-0.0926131913530074,-0.0385036357085077,-0.0322738692943373,0.0147479186411722,-0.00778311526825251,0.0711798913985952,0.0256853141380688,-0.0542742255964926,0.0263232138858234,0.0108436524955162,0.0235260171033010,-0.00867214286642433,0.0450634611083087,-0.0187355124839862,0.0268311074344552,-0.0267377287565816,0.0274965910530227,-0.0190062059953273,0.0238126402984115,0.0504438637650840,0.0425913834995603,-0.0574349073983557,-0.0133211116677426,-0.00727314074830399,0.0156169522719088,-0.0492865724397565,0.0228880150196214,0.00141876862573524,-0.00795277557535769,-0.0161094729906842,0.0242828616470274,0.0115961527010964,0.0381674026286192,-0.0217456132480019,-0.0300801156421270,0.0125916655943265,-0.0362607210552196,-0.00162520952016160,-0.00654638679560402,-0.0175380674714340,0.0173531857912599,0.0150212228888635,-0.00453355740039913,0.0226712522435586,-0.00123689942814438,-0.0901974838648239,-0.0100558288314569,-0.00964838304147270,0.0180444460037498,-0.00297745308470947,-0.0193733771613173,-0.0150512640529757,-0.0181769305449490,0.0120877042687195,-0.0465133812020605,0.0116548593364916,-0.0241562453677697,-0.0615612039216505,-0.0102564219486078,-0.0227592872033562,-0.0334235272008772,0.0344465943038626,-0.0671265010975580,0.000458541378948192,-0.0422758747901327,-0.0135320515878631,0.0169584800268670,0.0582737868103914,0.0387122805904871,0.00444348203860983,-0.0568149907886105,-0.00932108954434681,-0.0396072038013683,-0.00437280736778476,0.0676450002147177,0.0373704909448377,-0.0294229189974187,0.0127278038845513,0.00415510481943472,-0.0293520393422871,0.0199875991729263,-0.0363718700528166,0.00686045612127242,-0.00335770894592976,0.0133793647418108,0.00901705180305679,0.0159758066992111,-0.00557774516414607,0.0209023993197698,0.0357218604080456,-0.0259080189377507,0.0350601840893248,0.0408484843198242,-0.00682405796855033,0.0277330939437033,0.00327881317101678,0.0174868737495861,0.0523893683878400,-0.0316983792557779,0.0362134016209488,-0.0232157613921581,0.0180884474447710,0.0271105697757991,0.0371175561168147,0.00816152852681387,0.00115084536357665,-0.0182434126738990,-0.0405126701432783,-0.00642613460600357,-0.0382371705620621,0.0107342469999417,-0.00774916842911758,-0.0267856224408321,0.000309586941184472,-0.00708689988186140,-0.00324778891257193,-0.0277534372061799,0.0282150974974688,0.0251116914051400,-0.0108503962496370,-0.00219806249009698,0.0344829245276422,0.0350044972687569,0.0165233482313480,-0.0230388072541897,0.0340609644385632,0.00886858008119496,0.0287987713167520,0.00106662924325782,-0.0168910979009350,-0.00743998843636188,-0.0522097661511193,0.0473990120776709,0.0625556107426567,0.0314097476255960,-0.0264367305488213,-0.0783781398758831,-0.0447329461039800,0.0103124876094853,0.102150120301592,-0.0424033400227966,-0.00712595441042010,0.0129117669082893,-0.0299375664633747,0.0225908847695439,-0.0389924204993455,0.0335933129786218,-0.0542425830036065,-0.0211358740165894,0.0398264655927811,0.0199066592179921,0.0315621616301421,0.0202416417390845,0.00888958564869217,0.0365012615787341,-0.00419407168331612,-0.00449141773998357,-0.00546830617337323,0.0113629529717243,0.0484687039079834,-0.0463087174592497,0.0362132550137219,0.0191560948515575,0.0318522632350105,0.00950791905407691,0.0338525434018687,0.0657282662785040,-0.0363024719845291,-0.000500389854366379,0.0450089437879288,0.0114752109323462,0.0136978476093883,0.0149519431879647,0.0161478938981256,0.00337070576514527,-0.00483124061331184,0.00470064622386625,0.00786965619595591,-0.0399080747783372,-0.0397317749162559,0.0423838960389945,0.0306557890904200,0.0364640648265146,0.0357315072077656,0.0326962002025467,0.0689640773094168,0.0303355112025478,-0.0435891125175599,-0.00382637083697815,0.0132670951699975,-0.0321569147930938,0.00932094619438633,-0.00646946158874017,0.00444626222128830,-0.0325796604920921,0.0312663746250113,0.0389772919301163,0.0579855272919032,-0.00314176872506136,-0.0356691760484623,-0.0432525066257052,-0.0236249866458769,-0.00813446435861359,0.0174937798786921,0.0613632598254811,-0.0732375916337708,0.0137347987621625,-0.0245015895500940,-0.0138234753850552,0.00762918864920071,0.00688872402476260,-0.0278639905555975,0.0183870834982865,0.00934265183289850,0.0164039040053694,-0.0182744333295162,0.0251360482527747,0.0243865212896415,-0.000660710778384259,-0.00845599503006324,-0.0150340288312869,-0.00105292361994893,0.0143475726567264,-0.0135658352782526,0.0214362310952769,-0.0110274003605311,-0.0201057240396645,-0.00325622096222316,5.95919920559685e-05,-0.0449750365458333,0.0497879943699249,-0.0151635918496535,0.000423506857317673,0.0110626096247838,0.0147834189911653,0.0182444125623344,0.0273363465247356,-0.0155516201561917,-0.0255216993605652,0.00286811239814326,0.00306385515250658,-0.00377446991790540,-0.0218542909151436,-0.00642887098631262,0.0459805271154788,0.0382522115001586,-0.000368031005891927,0.0131994535489481,-0.0202856106107271,0.00386798452581967,0.0297703579261993,0.00367159156468723,-7.38518211871805e-05,-0.00240443233719106,0.0233708201975294,0.0156536227285202,-0.00917717383303588,-0.0128092807629650,-0.0155823305844657,0.0422476050134159,-0.000246510169254389,-0.00601405723933530,-0.0358767949351406,-0.0320952641042621,0.0339008607339346,-0.0562061260561393,-0.0514099834262426,-0.0563282485264301,0.0290172469819114,-0.0248824471751799,0.00873596367167660,-0.0492178276668367,-0.0427516996113133,-0.00661746249308714,-0.0310265854093435,-0.0271636969510172,-0.0239969754374979,0.0169133095716786,-0.00371127936204951,-0.0481122590773890,-0.0219293522398517,0.0565197644608946,-0.0319617273008470,0.0318508050361893,0.0192846438262342,0.00597489844579872,-0.0171779273287541,0.0593310030151484,0.00123729870185734,0.0199735557508306,-0.0146167031593391,0.0219253948272614,-0.00491987914675634,0.0255869893457357,-0.0335286857851269,0.0249912418181367,-0.0195019492330631,0.0318282191283496,0.0376011507870573,0.0338042689726913,-0.0107261099764940,-0.0159256288736577,0.000244953150517561,0.0109452323686437,0.0598006980827446,0.0119007200218829,0.0219111628938566,0.00562054967355578,0.00436558907750247,-0.00369337641821843,0.0261407003720269,-0.0339551706796600,-0.0117586786579497,-0.0217820712071462,0.0343794537640179,-0.0563947504157862,-0.0109593573808451,-0.00967702433824975,0.0122407940105393,-0.0222407468285619,-0.0214488773817486,0.0262861521402319,-0.0353565958168091,0.00528289201977013,-0.00118023213740381,-0.0511089428116588,-0.0434229418672211,-0.00153493372277034,0.00891976047068562,-0.0245900574323577,-0.0590452502135663,-0.0325367632729355,0.0627633641917280,0.0320634458579120,-0.0424815912613864,0.00980336506623633,-0.0179751007967518,-0.0500351266332520,0.0300528511819951,-0.0495382652677375,0.0195535755821663,0.0213721330192239,-0.0144006359913317,-0.000808075646561556,-0.0125156015323977,0.00114669257099497,0.00905338225719771,-0.0146454320623218,0.0235667767484695,-0.0824806072226520,-0.0189021739451384,0.0265792356773476,0.0422391325448068,0.0820044791083897,-0.0316509067334100,0.0257491510725333,0.00770485064759101,0.0248565005038703,-0.0429599791594532,-0.0400792405488687,0.0235645778082412,0.000692862697448380,0.0286091410405812,0.0388497862492447,0.0117911014275871,0.0381067256169253,0.0575686343182319,0.000573891964169284,0.0126657811594121,0.0238312897674223,-0.00829640847595085,-0.0298001761794627,0.00219679068269297,-0.00898743237437388,0.0403379458045586,0.0625662948901375,-0.0539401728459754,-0.0161703293719692,-0.0112118035289388,-0.00578565527891482,-0.0458464405967403,0.0157444583802332,-0.00892714180842960,-0.0587056660492743,-0.00361762643068250,-0.0595704971387898,0.0111211988910841,0.0901528233279955,-0.0348548950559280,-0.0617887328896823,-0.0380807285173355,-0.0345730306492591,-0.0399653360496165,0.0138400265985677,-0.0704310953808609,0.00388621707387078,0.0648390239730340,-0.00157655004863381,-0.0239731460465678,-0.0244053192811645,-0.0477409110062527,-0.0874783002912890,0.0261740341549093,-0.0335575919654373,0.0154242341097292,0.00604306578396234,-0.0303619921238205,-0.0705030707335225,-0.00793466905962990,-0.0294166311695307,-0.0127218025343387,-0.0631322514825583,-0.0526216916078230,0.0131399193871135,0.0123034895491889,-0.0477896960272069,0.0320554905042067,0.0511108330078894,-0.0872272063863553,-0.0136400396576365,-0.0373126795984807,0.00650158779245320,0.0306042832302776,0.0533140339639863,0.0105855701135188,-0.0557992780001021,0.0149191582686870,0.0107053956906062,-0.0347067890341317,0.0280530135055576,0.00963901837670734,0.0921150951951154,-0.0340282398393509,0.0243091111497905,0.0331559935863669,-0.0556395651295692,-0.0289994568846875,0.00910859115683438,-0.0747214547960305,0.0507642334272589,-0.0965144777299989,-0.00133739703486236,-0.0326196133917420,0.0195179848023697,-0.0230276648021484,0.0292390092177775,-0.0580836371051596,-0.0254496848016960,-0.0342660166442762,-0.0714383165704309,0.0407165861603459,0.0207080223893693,0.00622520198929053,-0.0109816872582479,0.0156589696242010,-0.0209390098024631,-0.0362821573679900,0.0127625700581010,-0.0129715476170384,0.0100125963416035,-0.0495052317962312,0.0291871210626749,0.000367937331857612,0.00553959934071849,-0.0337972681939327,-0.0562011370554015,0.0314248905884327,0.0192244678146573,0.00894803006922264,0.0810404148140783,-0.00392079991978710,0.0481875652976673,0.0439705105804096,-0.00993004431748473,-0.00732711912414714,-0.0601527311790815,-0.0130679009785237,-0.00262441714435728,0.0410368325467355,-0.00555051966639279,0.00606927058721968,0.0240797342066616,-0.0405538966979167,-0.0269815276686620,0.00570452162272378,0.00704203530602010,-0.0117514117792021,-0.00139960323721781,-0.0177733754711224,-0.00915021614110874,-0.0161910710318721,0.0320186940140509,-0.0190846647202054,-0.0589391649201696,0.0134628448472299,-0.0344612100432332,0.0279708161398791,0.0503594971454661,-0.0269770530445489,-0.0197201552971043,-0.0534098518299742,-0.0224333103043590,-0.0198789661966901,-0.0216401292180887,0.0325297190847264,0.0152126749662064,0.00895452033635067,0.0210502966100477,-0.0164887484780997,0.0405107181294692,-0.0482959157241381,-0.0344477592770271,-0.00510994657826185,0.0517723717507112,0.0888166188514172,-0.0440037925660938,0.0177100439009492,-0.0382133730912346,0.0474686157955519,-0.0781375566977182,-0.00236133388822118,0.0632774904448910,0.0452920239548291,-0.0287269784057885,0.0185931078049600,0.0452810695999641,-0.0380445094417864,-0.0392396217542450,-0.0210423294487829,0.0725546673051966,0.0307184562260227,0.0196082870418391,-0.00413933511544645,0.0677868781831027,0.0608309105461593,-0.0551123499060384,0.00598505198782518,-0.0189550545558186,-0.0162005410874063,-0.0165330431461909,0.0354672981362090,-0.0587079288628565,0.0569844305005612,-0.0238189333791583,0.0350957017572853,-0.0491032526129853,-0.0310086124342636,-0.0408450958312251,0.0320804211530742,0.00414076824016893,-0.00266690346666249,0.0510808731537801,0.0409632658600417,-0.0117877472696948,-0.0607229752622256,-0.00954978533559395,-0.00483657558802466,-0.0124463870955061,-0.00921207507148694,0.0752929844228063,-0.0160676584877604,0.0506784445330836,-0.0193567409551527,0.0103074848603111,-0.0544914537961453,-0.0326127103149381,0.0370375458859232,0.0401247015938379,-0.0869490353011837,0.0463087034954495,0.0615319898926010,0.0263750587304354,-0.0286256430311656,0.0473965237066077,0.0468702976769724,-0.00313390726888223,-0.120486883238831,0.0417395407757901,0.0116237256211592,0.0405781798279176,0.0175736168488413,-0.00375532467586930,0.0278936424801976,-0.0156014709505637];
% bias = [-6.44772834588090];
load('SVM_Model');
img_save = img_in;
s = size(img_in);
scale = 1;
boxes = [];
% while(s(1)>32 & s(2)>24)
    for i=1:6:s(1)-win_size(1),
        for j=1:6:s(2)-win_size(2),
            win = img_in(i:i+win_size(1)-1,j:j+win_size(2)-1,:);
            HSG_Vec = HSG_Feature(win);
            [label,score,cost] = svm_model.predict(HSG_Vec);
%             score = sum(sum(wts.*HSG_Vec))+bias;
            if(score(1)>2.75)
                boxes = [boxes;i/scale,j/scale,win_size(1)/scale,win_size(2)/scale,score];
            end
%             close all
%             pause(0.1);
        end
    end
    scale = scale*0.8;
    img_in = imresize(img_save,scale);
    s = size(img_in)
% end

s = size(boxes);
% boxes_out = nms(boxes, 0.5);
% s = size(boxes_out)
boxes_out = boxes;
for k=1:s(1)
    img_save = insertShape(img_save, 'rectangle', [boxes_out(k,2) boxes_out(k,1) boxes_out(k,4) boxes_out(k,3)], 'LineWidth', 1);
end
    img_save = imresize(img_save,8);
    

end

function top = nms(boxes, overlap)
% top = nms_fast(boxes, overlap)
% Non-maximum suppression. (FAST VERSION)
% Greedily select high-scoring detections and skip detections
% that are significantly covered by a previously selected
% detection.
% NOTE: This is adapted from Pedro Felzenszwalb's version (nms.m),
% but an inner loop has been eliminated to significantly speed it
% up in the case of a large number of boxes
% Tomasz Malisiewicz (tomasz@cmu.edu)

if isempty(boxes)
  top = [];
  return;
end

x1 = boxes(:,1);
y1 = boxes(:,2);
x2 = boxes(:,3) + boxes(:,1);
y2 = boxes(:,4) + boxes(:,2);
s = boxes(:,end);

area = (x2-x1+1) .* (y2-y1+1);
[vals, I] = sort(s);

pick = s*0;
counter = 1;
while ~isempty(I)
  
  last = length(I);
  i = I(last);  
  pick(counter) = i;
  counter = counter + 1;
  
  xx1 = max(x1(i), x1(I(1:last-1)));
  yy1 = max(y1(i), y1(I(1:last-1)));
  xx2 = min(x2(i), x2(I(1:last-1)));
  yy2 = min(y2(i), y2(I(1:last-1)));
  
  w = max(0.0, xx2-xx1+1);
  h = max(0.0, yy2-yy1+1);
  
  o = w.*h ./ area(I(1:last-1));
  
  I([last; find(o>overlap)]) = [];
end

pick = pick(1:(counter-1));
top = boxes(pick,:);
end

